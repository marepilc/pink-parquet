warning: in the working copy of 'src/lib/components/DataTable.svelte', LF will be replaced by CRLF the next time Git touches it
warning: in the working copy of 'src/lib/components/FileUpload.svelte', LF will be replaced by CRLF the next time Git touches it
warning: in the working copy of 'src/lib/components/SqlEditor.svelte', LF will be replaced by CRLF the next time Git touches it
warning: in the working copy of 'src/lib/components/Tabs.svelte', LF will be replaced by CRLF the next time Git touches it
warning: in the working copy of 'src/lib/components/query/QueryView.svelte', LF will be replaced by CRLF the next time Git touches it
warning: in the working copy of 'src/lib/stores/dataStore.svelte.ts', LF will be replaced by CRLF the next time Git touches it
warning: in the working copy of 'src/routes/+page.svelte', LF will be replaced by CRLF the next time Git touches it
diff --git a/src-tauri/src/lib.rs b/src-tauri/src/lib.rs
index 8d859f7..b1aa40d 100644
--- a/src-tauri/src/lib.rs
+++ b/src-tauri/src/lib.rs
@@ -37,14 +37,19 @@ fn table_name_from_path(path: &str) -> String {
         .file_stem()
         .and_then(|s| s.to_str())
         .unwrap_or("table");
-    let mut s = String::with_capacity(stem.len());
-    for ch in stem.chars() {
+    let mut s = String::with_capacity(stem.len() + 1);
+
+    for (i, ch) in stem.chars().enumerate() {
+        if i == 0 && ch.is_ascii_digit() {
+            s.push('_');
+        }
         if ch.is_ascii_alphanumeric() {
             s.push(ch);
         } else {
             s.push('_');
         }
     }
+
     if s.is_empty() {
         s.push_str("table");
     }
@@ -142,11 +147,12 @@ fn execute_sql(
     for path in &all_files {
         let lf = open_parquet(path)?;
         let table_name = table_name_from_path(path);
+        eprintln!("Registering table: {} from path: {}", table_name, path);
         ctx.register(&table_name, lf);
     }

     // Build main query lazyframe
-    let qlf = ctx.execute(&query).map_err(|e| {
+    let mut qlf = ctx.execute(&query).map_err(|e| {
         let table_names: Vec<String> = all_files.iter().map(|p| table_name_from_path(p)).collect();
         format!(
             "SQL execution error: {}. Available tables: {:?}",
@@ -160,14 +166,28 @@ fn execute_sql(
         .select([polars::prelude::len().alias("cnt")])
         .collect()
         .map_err(|e| format!("Failed to count rows: {}", e))?;
+
     let total_rows = cnt_df
         .column("cnt")
         .ok()
         .and_then(|s| s.get(0).ok())
-        .map(|v| v.try_extract::<u32>().ok().map(|u| u as usize))
-        .flatten()
+        .and_then(|v| {
+            // Try to extract as various integer types
+            v.try_extract::<u64>()
+                .ok()
+                .or_else(|| v.try_extract::<u32>().ok().map(|u| u as u64))
+                .or_else(|| v.try_extract::<i64>().ok().map(|i| i as u64))
+                .or_else(|| v.try_extract::<i32>().ok().map(|i| i as u64))
+        })
+        .map(|u| u as usize)
         .unwrap_or(0);

+    eprintln!(
+        "SQL Query successful. Total rows: {}, width: {}",
+        total_rows,
+        qlf.collect_schema().map(|s| s.len()).unwrap_or(0)
+    );
+
     // Page the data
     let page_df = qlf
         .slice(offset as i64, limit as u32)
@@ -211,6 +231,10 @@ fn get_more_sql_rows(
     for path in &all_files {
         let lf = open_parquet(path)?;
         let table_name = table_name_from_path(path);
+        eprintln!(
+            "Registering table (more rows): {} from path: {}",
+            table_name, path
+        );
         ctx.register(&table_name, lf);
     }

diff --git a/src/lib/components/DataTable.svelte b/src/lib/components/DataTable.svelte
index 96899d4..7f79aea 100644
--- a/src/lib/components/DataTable.svelte
+++ b/src/lib/components/DataTable.svelte
@@ -61,6 +61,18 @@
   const data = $derived(dataStore.data)
   const columns = $derived(data?.columns || [])
   const rows = $derived(data?.rows || [])
+
+  $effect(() => {
+    console.log('DataTable visibility check:', {
+      hasData: !!data,
+      isSqlTabActive: dataStore.isSqlTabActive,
+      columnsCount: columns.length,
+      rowsCount: rows.length,
+      loading: dataStore.loading,
+      hasSessions: dataStore.sessions.length
+    })
+  })
+
   const totalRows = $derived(dataStore.totalRows)
   const loadedRows = $derived(dataStore.loadedRows)
   const hasMoreRows = $derived(loadedRows < totalRows)
@@ -149,12 +161,14 @@
   async function reloadData() {
     if (!dataStore.activeSession?.path) return
     dataStore.setLoading(true)
+    console.log('DataTable.reloadData: Start', { isSqlTabActive: dataStore.isSqlTabActive })
     try {
       const isQuery = dataStore.isSqlTabActive && dataStore.isQueryMode
       const sorting = !isQuery && sortStates.length > 0 ? sortStates : null

       let newData: any
       if (isQuery && dataStore.currentQuery) {
+        console.log('DataTable.reloadData: Executing SQL', dataStore.currentQuery)
         newData = await invoke('execute_sql', {
           activeFilePath: dataStore.activeSession?.path,
           allFiles: dataStore.sessions.map((s) => s.path),
@@ -163,13 +177,15 @@
           limit: BATCH_SIZE,
         })
       } else {
+        console.log('DataTable.reloadData: Getting raw data')
         newData = await invoke('get_data', {
           filePath: dataStore.activeSession?.path,
           sorting,
         })
       }

-      dataStore.setData(newData as any)
+      console.log('DataTable.reloadData: Data received', { rows: newData.rows.length })
+      dataStore.setData(newData as any, undefined, isQuery)
     } catch (error) {
       console.error('Error reloading data:', error)
       dataStore.setError(String(error))
@@ -235,14 +251,26 @@
     }
   })

-  // Re-measure when columns change (Svelte 5: $effect takes a single callback and auto-tracks deps)
+  // Re-measure when data or columns change
   $effect(() => {
+    // Accessing columns and rows makes this effect run whenever they change
+    const colsCount = columns.length;
+    const rowsCount = rows.length;
+
+    if (colsCount === 0) {
+      console.log('DataTable - No columns, skipping measurement');
+      return;
+    }
+
+    console.log('DataTable - data changed, re-measuring.', { colsCount, rowsCount });
+
     // Reset layout to auto to let the browser compute natural widths when columns update
     tableLayout = 'auto'
-    // Clear previous column widths to avoid reusing stale widths when reopening files
+    // Clear previous column widths to allow re-calculation
     columnWidths = new Map()
-    // Reset header cell refs to be re-bound by the template
+    // Reset header cell refs
     headerCells = []
+
     // Defer measurement to the next microtask / paint
     queueMicrotask(() => {
       measureAndLockColumnWidths()
@@ -366,24 +394,42 @@
           {/each}
         </tr>
       </thead>
-      <tbody>
-        {#each rows as row}
-          <tr
-            class="border-surface-3/50 hover:bg-surface-2/50 border-b transition-colors"
-          >
-            {#each row as cell}
-              <td
-                class="text-surface-5 truncate overflow-hidden px-3 py-2 text-[13px]"
-                style={`min-width:${MIN_COL_WIDTH}px`}
-                title={stripQuotes(cell)}
-              >
-                {stripQuotes(cell)}
-              </td>
-            {/each}
-          </tr>
-        {/each}
-
-        <!-- Loading indicator -->
+  <tbody>
+    {#if rows.length > 0}
+      {#each rows as row, rowIndex (row)}
+        <tr
+          class="border-surface-3/50 hover:bg-surface-2/50 border-b transition-colors"
+        >
+          {#each row as cell}
+            <td
+              class="text-surface-5 truncate overflow-hidden px-3 py-2 text-[13px]"
+              style={`min-width:${MIN_COL_WIDTH}px`}
+              title={stripQuotes(cell)}
+            >
+              {stripQuotes(cell)}
+            </td>
+          {/each}
+        </tr>
+      {/each}
+    {:else if !dataStore.loading && dataStore.hasData}
+      <tr>
+        <td
+          colspan={columns.length || 1}
+          class="text-surface-4 px-4 py-20 text-center"
+        >
+          <div class="flex flex-col items-center gap-2">
+            <span class="text-lg font-medium"
+              >{dataStore.isSqlTabActive ? 'No SQL results' : 'No data'}</span
+            >
+            {#if dataStore.isSqlTabActive && !dataStore.currentQuery}
+              <span class="text-sm">Enter a query and press Run</span>
+            {/if}
+          </div>
+        </td>
+      </tr>
+    {/if}
+
+    <!-- Loading indicator -->
         {#if isLoadingMore}
           <tr>
             <td colspan={columns.length} class="px-4 py-4 text-center">
diff --git a/src/lib/components/FileUpload.svelte b/src/lib/components/FileUpload.svelte
index 16757f1..ee38b75 100644
--- a/src/lib/components/FileUpload.svelte
+++ b/src/lib/components/FileUpload.svelte
@@ -20,7 +20,7 @@
         filePath,
         sorting: null,
       })
-      dataStore.setData(data as any, sessionId)
+      dataStore.setData(data as any, sessionId, false)
     } catch (error) {
       console.error('Error loading Parquet file:', error)
       dataStore.setError(String(error), sessionId)
diff --git a/src/lib/components/SqlEditor.svelte b/src/lib/components/SqlEditor.svelte
index 3f9bfa7..e8f0c95 100644
--- a/src/lib/components/SqlEditor.svelte
+++ b/src/lib/components/SqlEditor.svelte
@@ -255,7 +255,7 @@
       tr.changes.iterChangedRanges((fromA, toA, fromB, toB) => {
         // Only scan if something was added (fromB < toB means something was inserted)
         // If fromB === toB, it's a pure deletion, so we skip to avoid feedback loops.
-        if (fromB === toB) return
+        if (fromB >= toB) return

         // Expand to the line to re-scan safely
         const line = tr.newDoc.lineAt(fromB)
diff --git a/src/lib/components/Tabs.svelte b/src/lib/components/Tabs.svelte
index b47948a..a65dc82 100644
--- a/src/lib/components/Tabs.svelte
+++ b/src/lib/components/Tabs.svelte
@@ -13,7 +13,7 @@
         filePath,
         sorting: null,
       })
-      dataStore.setData(data as any, sessionId)
+      dataStore.setData(data as any, sessionId, false)
     } catch (error) {
       console.error('Error loading Parquet file:', error)
       dataStore.setError(String(error), sessionId)
@@ -60,7 +60,10 @@
         {!dataStore.isSqlTabActive && dataStore.activeSessionId === session.id
         ? 'bg-surface text-primary shadow-[0_2px_10px_rgba(0,0,0,0.1)]'
         : 'text-surface-5 hover:bg-surface-1 hover:text-surface-6'}"
-      onclick={() => (dataStore.activeSessionId = session.id)}
+      onclick={() => {
+        dataStore.activeSessionId = session.id
+        dataStore.isSqlTabActive = false
+      }}
       onkeydown={(e) => {
         if (e.key === 'Enter' || e.key === ' ') {
           e.preventDefault()
diff --git a/src/lib/components/query/QueryView.svelte b/src/lib/components/query/QueryView.svelte
index 71dd3c4..2dfa887 100644
--- a/src/lib/components/query/QueryView.svelte
+++ b/src/lib/components/query/QueryView.svelte
@@ -9,15 +9,6 @@
     sqlText = dataStore.currentQuery || ''
   })

-  function tableName(): string {
-    const path = dataStore.activeSession?.path
-    return path
-      ? (path.split('\\').pop()?.split('/').pop() || '')
-          .replace(/\.[^/.]+$/, '')
-          .replace(/[^A-Za-z0-9]/g, '_')
-      : 'table'
-  }
-
   const keywordCompletions = [
     'select',
     'from',
@@ -46,14 +37,22 @@
     'between',
   ].map((k) => ({ label: k.toUpperCase(), type: 'keyword' }))

+  function sanitizeTableName(path: string): string {
+    const fileName = path.split('\\').pop()?.split('/').pop() || ''
+    const stem = fileName.replace(/\.[^/.]+$/, '')
+    let sanitized = stem.replace(/[^A-Za-z0-9]/g, '_')
+    if (/^[0-9]/.test(sanitized)) {
+      sanitized = '_' + sanitized
+    }
+    return sanitized || 'table'
+  }
+
   function getTableAndColumnCompletions() {
     const tableCompletions: { label: string; type: string }[] = []
     const columnCompletions: { label: string; type: string }[] = []

     dataStore.sessions.forEach((session) => {
-      const name = (session.path.split('\\').pop()?.split('/').pop() || '')
-        .replace(/\.[^/.]+$/, '')
-        .replace(/[^A-Za-z0-9]/g, '_')
+      const name = sanitizeTableName(session.path)

       tableCompletions.push({ label: name, type: 'class' })

@@ -83,20 +82,36 @@
   async function runSql() {
     if (!dataStore.activeSession?.path) return
     const q = sqlText.trim()
-    dataStore.setQuery(q)
+    if (!q) return

+    dataStore.setQuery(q)
     dataStore.setLoading(true)
+
     try {
+      // Ensure we are in SQL tab mode
+      dataStore.isSqlTabActive = true
+
+      console.log('QueryView: Executing SQL', {
+        q,
+        isSqlTabActive: dataStore.isSqlTabActive,
+      })
+
       const newData = await invoke('execute_sql', {
         activeFilePath: dataStore.activeSession?.path,
         allFiles: dataStore.sessions.map((s) => s.path),
         query: q,
         offset: 0,
-        limit: 100, // Matches BATCH_SIZE in DataTable
+        limit: 100,
+      })
+
+      console.log('QueryView: SQL result received', {
+        rows: (newData as any).rows?.length,
+        columns: (newData as any).columns?.length,
       })
-      dataStore.setData(newData as any)
+
+      dataStore.setData(newData as any, undefined, true)
     } catch (error) {
-      console.error('Error executing SQL:', error)
+      console.error('QueryView: SQL execution failed', error)
       dataStore.setError(String(error))
     }
   }
@@ -104,16 +119,11 @@
   async function clearSql() {
     sqlText = ''
     dataStore.setQuery(null)
-    dataStore.setLoading(true)
-    try {
-      const newData = await invoke('get_data', {
-        filePath: dataStore.activeSession?.path,
-        sorting: null,
-      })
-      dataStore.setData(newData as any)
-    } catch (error) {
-      console.error('Error clearing SQL:', error)
-      dataStore.setError(String(error))
+    // When clearing SQL, we just want to clear the queryData in the store,
+    // not fetch raw data again into the rawData slot which might be confusing.
+    const session = dataStore.activeSession
+    if (session) {
+      session.queryData = null
     }
   }
 </script>
@@ -124,7 +134,7 @@
       <SqlEditor
         value={sqlText}
         onChange={(v) => (sqlText = v)}
-        placeholder={`-- SQL. Table name: ${tableName()}`}
+        placeholder={`-- SQL. Active table: ${sanitizeTableName(dataStore.activeSession?.path || '')}`}
         tableName={tableCompletions.map((t) => t.label)}
         columns={columnCompletions}
         onRun={runSql}
diff --git a/src/lib/stores/dataStore.svelte.ts b/src/lib/stores/dataStore.svelte.ts
index 375e4c1..70fa154 100644
--- a/src/lib/stores/dataStore.svelte.ts
+++ b/src/lib/stores/dataStore.svelte.ts
@@ -55,12 +55,35 @@ export const dataStore = {
     return isSqlTabActive
   },
   set isSqlTabActive(value: boolean) {
+    console.log('dataStore.isSqlTabActive setter', value)
     isSqlTabActive = value
+    // If we switch to SQL tab, we should ensure the active session's query is reflected.
+    // If no query is present, queryData should remain null or as it was.
   },
   get data() {
-    const session = this.activeSession
-    if (!session) return null
-    return isSqlTabActive ? session.queryData : session.rawData
+    // Directly find the active session from the reactive sessions array
+    // to ensure deep reactivity works as expected in Svelte 5.
+    const session = sessions.find((s) => s.id === activeSessionId)
+    if (!session) {
+      console.log('dataStore.data getter: No active session')
+      return null
+    }
+
+    // Explicitly access isSqlTabActive to track it
+    const active = isSqlTabActive
+    // If SQL tab is active, we MUST return queryData.
+    // If queryData is null (e.g. before first run or after clear), return null.
+    const result = active ? session.queryData : session.rawData
+
+    console.log('dataStore.data getter', {
+      sessionId: session.id,
+      isSqlTabActive: active,
+      hasQueryData: !!session.queryData,
+      hasRawData: !!session.rawData,
+      rows: result?.rows.length || 0,
+      columns: result?.columns.length || 0,
+    })
+    return result
   },
   get loading() {
     return this.activeSession?.loading || false
@@ -126,24 +149,51 @@ export const dataStore = {
     }
   },

-  setData(newData: ParquetData, sessionId?: string) {
+  setData(newData: ParquetData, sessionId?: string, isSqlResult?: boolean) {
     const session = sessionId
       ? sessions.find((s) => s.id === sessionId)
       : this.activeSession
+
+    const effectiveIsSql =
+      isSqlResult !== undefined ? isSqlResult : isSqlTabActive
+
+    console.log('dataStore.setData called', {
+      sessionId: session?.id,
+      isSqlTabActive,
+      isSqlResult,
+      effectiveIsSql,
+      rows: newData.rows.length,
+      columns: newData.columns.length,
+    })
+
     if (session) {
-      if (isSqlTabActive) {
-        session.queryData = newData
+      if (effectiveIsSql) {
+        console.log('Updating queryData for session', session.id)
+        session.queryData = {
+          shape: [...newData.shape] as [number, number],
+          columns: [...newData.columns],
+          rows: [...newData.rows],
+          metadata: newData.metadata ? { ...newData.metadata } : undefined,
+        }
       } else {
-        session.rawData = newData
+        console.log('Updating rawData for session', session.id)
+        session.rawData = {
+          shape: [...newData.shape] as [number, number],
+          columns: [...newData.columns],
+          rows: [...newData.rows],
+          metadata: newData.metadata ? { ...newData.metadata } : undefined,
+        }
         if (
           session.currentQuery === null ||
           session.currentQuery.trim().length === 0
         ) {
-          session.baseColumns = newData.columns
+          session.baseColumns = [...newData.columns]
         }
       }
       session.error = null
       session.loading = false
+    } else {
+      console.warn('dataStore.setData: No session found to update')
     }
   },

diff --git a/src/routes/+page.svelte b/src/routes/+page.svelte
index 321a773..814cd56 100644
--- a/src/routes/+page.svelte
+++ b/src/routes/+page.svelte
@@ -10,9 +10,9 @@
 {#if dataStore.hasData}
   <div class="flex h-full flex-col">
     {#if dataStore.isSqlTabActive}
-      <QueryView key={dataStore.activeSessionId} />
+      <QueryView />
     {/if}
-    <DataTable key={dataStore.activeSessionId} />
+    <DataTable />
     <Tabs />
     <InfoBar />
   </div>